# nerve

STM32H723ZG with telemetry ICs.

---

<details markdown="1">
  <summary>Table of Contents</summary>

- [1 Pin Configurations](#1-pin-configurations)
- [2 BNO085](#2-bno085)
    - [2.1 Serial Peripheral Interface (SPI)](#21-serial-peripheral-interface-spi)
        - [2.1.1 Full-Duplex vs. Half-Duplex](#211-full-duplex-vs-half-duplex)
        - [2.1.2 Clock Polarity, Phase and Modes](#212-clock-polarity-phase-and-modes)
    - [2.2 Sensor Fusion Concepts](#22-sensor-fusion-concepts)
        - [2.2.1 Euler Angles](#221-euler-angles)
        - [2.2.2 Quaternions](#222-quaternions)

</details>

---

## 1 Pin Configurations

| STM32L432KC Pin | Config      | Connection                     |
|-----------------|-------------|--------------------------------|
| PE2             | SPI4_SCK    | BNO085 Pin 19: H_SCL/SCK/RX    |
| PE4             | SPI4_NSS CS | BNO085 Pin 18: H_CSN           |
| PE5             | SPI4_MISO   | BNO085 Pin 20: H_SDA/H_MISO/TX |
| PE6             | SPI4_MOSI   | BNO085 Pin 17: SA0/H_MOSI      |
| PF1             | GPIO_Output | BNO085 Pin 6: PS0/Wake         |
| PF2             | GPIO_EXTI2  | BNO085 Pin 14: H_INTN          |
| PF3             | GPIO_Output | BNO085 Pin 11: NRST            |

---

## 2 BNO085

A 9-axis Inertial Measurement Unit (IMU) combining an accelerometer, gyroscope,
and magnetometer, based on Bosch Sensortec's BNO080 hardware, with sensor fusion
firmware developed by CEVA, Inc. (formerly Hillcrest Laboratories).

### 2.1 Serial Peripheral Interface (SPI)

In an SPI setup, there is always one controller (master) connected to one or
more peripherals (slaves). The controller controls the communication by
generating a clock signal (SCK) and selecting which slave to communicate with
using the Chip Select (CS) line. Data is exchanged between the controller and
peripheral(s) over two data lines: COPI / MOSI and CIPO or MISO.

Basic pinouts:

1. Clock (SCK)
    - The clock signal generated by the master device that synchronizes data
      transfer in SPI communication.

2. Chip Select (CS) or Slave Select (NSS)
    - A signal used to select a specific slave device in SPI communication. When
      the CS line is active (usually low), the selected slave device is enabled
      to communicate with the master.

3. Controller Out Peripheral In (COPI) or Master Out Slave In (MOSI)
    - The data line used to transfer data from the master device to the slave
      device. The master outputs data on this line, which the slave reads.

4. Controller In Peripheral Out (CIPO) or Master In Slave Out (MISO)
    - The data line used to transfer data from the slave device to the master
      device. The slave outputs data on this line, which the master reads.

#### 2.1.1 Full-Duplex vs. Half-Duplex

Full-Duplex: Data can be sent and received simultaneously.

Half-Duplex: Data is either sent or received at any given time, not both
simultaneously.

#### 2.1.2 Clock Polarity, Phase and Modes

CPOL (Clock Polarity): determines the idle state of the clock signal (SCK).

- CPOL = 0: The clock is low (0) when idle.
- CPOL = 1: The clock is high (1) when idle.

CPHA (Clock Phase): determines when data is sampled relative to the clock
signal.

- CPHA = 0: Data is sampled on the leading (first) clock edge.
- CPHA = 1: Data is sampled on the trailing (second) clock edge.

SPI Modes (Combination of CPOL and CPHA):

| Mode | CPOL | CPHA | SCK idle state | Data captured on...               | Data output on ... |
|:----:|:----:|:----:|:--------------:|-----------------------------------|--------------------|
|  0   |  0   |  0   |    Low (0)     | Rising edge of SCK (first edge)   | Falling edge       |
|  1   |  0   |  1   |    Low (0)     | Falling edge of SCK (second edge) | Rising edge        |
|  2   |  1   |  0   |    High (1)    | Falling edge of SCK (first edge)  | Rising edge        |
|  3   |  1   |  1   |    High (1)    | Rising edge of SCK (second edge)  | Falling edge       |

#### 2.1.3 General-Purpose Input/Output (GPIO) Output

#### 2.1.4 GPIO External Interrupt/Event Controller (EXTI)

### 2.2 BNO085 Driver

The BNO085 driver is made of 2 files:

1. [driver_bno085.h](Core/Inc/driver_bno085.h)
2. [driver_bno085.c](Core/Src/driver_bno085.c)

#### 2.2.1 State Machine

```
â†“
```

### 2.3 Sensor Fusion Concepts

#### 2.3.1 Euler Angles

#### 2.3.2 Quaternions
